# handlers/sell/sell_router.py
import logging

from aiogram import Router, F
from aiogram.types import CallbackQuery

# –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
from database import user_manager # <--- –í—ñ–Ω –≤–∂–µ —Ç—É—Ç, —Ü–µ —á—É–¥–æ–≤–æ

# –Ü–º–ø–æ—Ä—Ç–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏, –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
from aiogram.filters import Command
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton

# 1. –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç —Ä–æ—É—Ç–µ—Ä–∞
sell_router = Router()


# -------------------------------------------------------------------
# –û–ë–†–û–ë–ù–ò–ö ‚Ññ1: –î–õ–Ø –ö–û–ú–ê–ù–î–ò /sell (–û–ù–û–í–õ–ï–ù–ê –í–ï–†–°–Ü–Ø)
# -------------------------------------------------------------------
@sell_router.message(Command("sell"))
async def handle_sell_command(message: Message):
    """
    –û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /sell.
    –¢–µ–ø–µ—Ä –≤—ñ–Ω –ü–ï–†–ï–í–Ü–†–Ø–Ñ, —á–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, 
    —ñ –ø–æ–∫–∞–∑—É—î —Ä—ñ–∑–Ω–∏–π —Ç–µ–∫—Å—Ç/–∫–Ω–æ–ø–∫–∏.
    """
    
    # 1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ –±–∞–∑—ñ (–ë–ï–ó —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è)
    user = await user_manager.get_user_by_id(message.from_user.id)
    
    if user is None:
        # 2. –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ù–ï–ú–ê–Ñ –≤ –±–∞–∑—ñ (–≤—ñ–Ω —Å–ø—Ä–∞–≤–¥—ñ –Ω–æ–≤–∏–π)
        button_text = "‚ö†Ô∏è –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è —Ç–∞ –ø–æ—á–∞—Ç–∏"
        message_text = (
            "–í—ñ—Ç–∞—é! –°—Ö–æ–∂–µ, –≤–∏ —Ç—É—Ç –≤–ø–µ—Ä—à–µ.\n\n"
            "–î–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω—å –ø–æ—Ç—Ä—ñ–±–Ω–∞ —à–≤–∏–¥–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è. "
            "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏."
        )
    else:
        # 3. –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –í–ñ–ï —î –≤ –±–∞–∑—ñ (–≤—ñ–Ω –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è)
        button_text = "üöó –†–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ –Ω–æ–≤–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è"
        message_text = (
            f"–†–∞–¥—ñ –±–∞—á–∏—Ç–∏ –≤–∞—Å –∑–Ω–æ–≤—É, {user['full_name']}!\n\n"
            "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è."
        )

    # 4. –°—Ç–≤–æ—Ä—é—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text=button_text, 
                    callback_data="sell_car" # <--- callback_data —Ç–∞ —Å–∞–º–∞!
                )
            ]
        ]
    )
    
    await message.answer(message_text, reply_markup=keyboard)


# -------------------------------------------------------------------
# –û–ë–†–û–ë–ù–ò–ö ‚Ññ2: –î–õ–Ø –ù–ê–¢–ò–°–ö–ê–ù–ù–Ø –ö–ù–û–ü–ö–ò (–ë–ï–ó –ó–ú–Ü–ù)
# -------------------------------------------------------------------
@sell_router.callback_query(F.data == "sell_car")
async def handle_sell_car(callback: CallbackQuery):
    """
    –¶–µ–π –æ–±—Ä–æ–±–Ω–∏–∫ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ë–ï–ó –ó–ú–Ü–ù.
    –í—ñ–Ω, —è–∫ —ñ —Ä–∞–Ω—ñ—à–µ, –≤–∏–∫–ª–∏–∫–∞—î get_or_create_user,
    —è–∫–∏–π –∞–±–æ –∑–Ω–∞–π–¥–µ, –∞–±–æ –°–¢–í–û–†–ò–¢–¨ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞,
    –∞ –ø–æ—Ç—ñ–º –æ–Ω–æ–≤–∏—Ç—å –π–æ–≥–æ —Ä–æ–ª—å –Ω–∞ "seller", —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ.
    """
    try:
        user_data = callback.from_user
        
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ .first_name, —è–∫ –≤–∏ –ø—Ä–æ—Å–∏–ª–∏
        user = await user_manager.get_or_create_user(
            telegram_id=user_data.id,
            full_name=user_data.first_name, 
            username=user_data.username
        )
        
        # –¶—è –ª–æ–≥—ñ–∫–∞, —è–∫ —ñ —Ä–∞–Ω—ñ—à–µ, –æ–±—Ä–æ–±–ª—è—î –æ–±–∏–¥–≤–∞ –≤–∏–ø–∞–¥–∫–∏
        if user['role'] == 'buyer':
            await user_manager.set_user_role_seller(user_data.id)
            
            await callback.message.answer(
                "‚úÖ **–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ!**\n"
                "–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —è–∫ **–ü—Ä–æ–¥–∞–≤–µ—Ü—å**.\n\n"
                "–¢–µ–ø–µ—Ä –¥–∞–≤–∞–π—Ç–µ –¥–æ–¥–∞–º–æ –≤–∞—à–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è..."
            )
        else:
            await callback.message.answer(
                f"–ü–æ—á–∏–Ω–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è..."
            )

        # 3. –¢—É—Ç –≤–∏ –∑–∞–ø—É—Å–∫–∞—î—Ç–µ FSM (–º–∞—à–∏–Ω—É —Å—Ç–∞–Ω—ñ–≤)
        
        await callback.answer()

    except Exception as e:
        logging.error(f"–ü–æ–º–∏–ª–∫–∞ –≤ handle_sell_car: {e}", exc_info=True) 
        await callback.message.answer(
            "‚ùå **–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞**\n\n"
            "–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—ñ–¥ —á–∞—Å –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö. "
            "–°–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ /start –∞–±–æ /sell —â–µ —Ä–∞–∑."
        )
        await callback.answer("–ü–æ–º–∏–ª–∫–∞! –î–∏–≤. –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏—â–µ.", show_alert=True)