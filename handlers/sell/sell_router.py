# handlers/sell/sell_router.py
import logging

from aiogram import Router, F
from aiogram.types import CallbackQuery

# –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
from database import user_manager

# –Ü–º–ø–æ—Ä—Ç–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏, –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
from aiogram.filters import Command
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton

# 1. –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç —Ä–æ—É—Ç–µ—Ä–∞
sell_router = Router()


# -------------------------------------------------------------------
# –û–ë–†–û–ë–ù–ò–ö ‚Ññ1: –î–õ–Ø –ö–û–ú–ê–ù–î–ò /sell
# (–í–∏–ø–∞–¥–∫–æ–≤–æ –≤–∏–¥–∞–ª–µ–Ω–∏–π —É –≤–∞—à—ñ–π –æ—Å—Ç–∞–Ω–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó)
# -------------------------------------------------------------------
@sell_router.message(Command("sell"))
async def handle_sell_command(message: Message):
    """
    –û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /sell.
    –ù–∞–¥—Å–∏–ª–∞—î –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–∞—Ç–∏ –∞–≤—Ç–æ", —è–∫–∞ –∑–∞–ø—É—Å–∫–∞—î handle_sell_car.
    """

    # –°—Ç–≤–æ—Ä—é—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üöó –†–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è", callback_data="sell_car"
                )
            ]
        ]
    )

    await message.answer(
        "–í–∏ –≤–∏—Ä—ñ—à–∏–ª–∏ –ø—Ä–æ–¥–∞—Ç–∏ –∞–≤—Ç–æ–º–æ–±—ñ–ª—å. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏.",
        reply_markup=keyboard,
    )


# -------------------------------------------------------------------
# –û–ë–†–û–ë–ù–ò–ö ‚Ññ2: –î–õ–Ø –ù–ê–¢–ò–°–ö–ê–ù–ù–Ø –ö–ù–û–ü–ö–ò (–∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫)
# -------------------------------------------------------------------
@sell_router.callback_query(F.data == "sell_car")
async def handle_sell_car(callback: CallbackQuery):
    """
    –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–∞—Ç–∏ –∞–≤—Ç–æ".
    –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –¢–ê –û–ù–û–í–õ–Æ–Ñ –†–û–õ–¨.
    (–ó –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫)
    """
    try:
        user_data = callback.from_user

        # 1. –°–ø—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        user = await user_manager.get_or_create_user(
            telegram_id=user_data.id,
            full_name=user_data.full_name,
            username=user_data.username,
        )

        # 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–ª—ñ
        if user["role"] == "buyer":
            await user_manager.set_user_role_seller(user_data.id)

            await callback.message.answer(
                "–í—ñ—Ç–∞—é! –í–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—è —è–∫ **–ü—Ä–æ–¥–∞–≤–µ—Ü—å**.\n\n"
                "–¢–µ–ø–µ—Ä –¥–∞–≤–∞–π—Ç–µ –¥–æ–¥–∞–º–æ –≤–∞—à–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è..."
            )
        else:
            await callback.message.answer(
                f"–†–∞–¥—ñ –≤–∞—Å –±–∞—á–∏—Ç–∏ –∑–Ω–æ–≤—É, {user['full_name']}!\n\n"
                "–ü–æ—á–∏–Ω–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è..."
            )

        # 3. –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ Telegram, —â–æ –∫–Ω–æ–ø–∫–∞ –æ–±—Ä–æ–±–ª–µ–Ω–∞ –£–°–ü–Ü–®–ù–û
        await callback.answer()

    except Exception as e:
        # 4. –Ø–ö–©–û –©–û–°–¨ –ü–Ü–®–õ–û –ù–ï –¢–ê–ö (–Ω–∞–ø—Ä. –ø–æ–º–∏–ª–∫–∞ –ë–î)
        # –õ–æ–≥—É—î–º–æ –ø–æ–º–∏–ª–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
        logging.error(f"–ü–æ–º–∏–ª–∫–∞ –≤ handle_sell_car: {e}", exc_info=True)

        # –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É
        await callback.message.answer(
            "‚ùå **–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞**\n\n"
            "–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—ñ–¥ —á–∞—Å –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö. "
            "–°–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ /start –∞–±–æ /sell —â–µ —Ä–∞–∑."
        )

        # –Ü –ì–û–õ–û–í–ù–ï: –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ –Ω–∞ –∫–Ω–æ–ø–∫—É, —â–æ–± –≤–æ–Ω–∞ –ø–µ—Ä–µ—Å—Ç–∞–ª–∞ –∫—Ä—É—Ç–∏—Ç–∏—Å—è
        await callback.answer("–ü–æ–º–∏–ª–∫–∞! –î–∏–≤. –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏—â–µ.", show_alert=True)
